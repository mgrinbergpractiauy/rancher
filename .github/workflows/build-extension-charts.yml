name: Build extension artifact

on:
  push:
    branches:
      - 'main'
    paths:
      - 'charts/**'
      - 'extensions/**'
      - 'pkg/**'
      - 'chart/**'
      - 'package.json'
      - 'yarn.lock'
      - '.github/workflows/build-extension-charts.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build extension artifact
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      # --- CORRECCIÓN #1: Dependencia para md5 (Checksum) ---
      - name: Install Missing System Dependencies (checksum fix)
        run: |
          sudo apt-get update
          sudo apt-get install -y coreutils bsdmainutils
          
      - name: Set up Environment Variables
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "TAG_NAME=main" >> $GITHUB_OUTPUT
          else
            echo "TAG_NAME=v1.0.0-manual-test" >> $GITHUB_OUTPUT
          fi
          
      - name: Checkout (normal flow)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          repository: mgrinbergpractiauy/rancher
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # --- CORRECCIÓN #2: Reorganización con la ruta PLURAL CONFIRMADA (charts/) ---
      - name: Reorganize Extension and Chart Folders (FINAL FIX based on user path)
        run: |
          echo "--- Reorganizando Extensión (./pkg/cluster-log-extension) ---"
          mkdir -p extensions
          if [ -d "./pkg/cluster-log-extension" ]; then
            mv ./pkg/cluster-log-extension ./extensions/
            echo "Extensión movida correctamente a ./extensions/."
          else
            echo "ERROR: Directorio ./pkg/cluster-log-extension no encontrado. El código fuente debe estar presente."
            exit 1 
          fi

          echo "--- Reorganizando Chart (Ubicación Confirmada: ./charts) ---"
          # La carpeta de destino del chart que espera el script 'publish-pkgs'
          CHART_DEST_DIR="charts/cluster-log-extension"
          mkdir -p "$CHART_DEST_DIR"
          
          # 1. Buscamos los archivos en la ubicación confirmada (./charts/)
          if [ -f "./charts/Chart.yaml" ]; then
            echo "Chart.yaml encontrado en la ruta ./charts/. Moviendo contenidos..."
            
            # Mueve todos los archivos del chart (excepto la subcarpeta que acabamos de crear)
            # a la subcarpeta requerida por el publish script (charts/cluster-log-extension/)
            find ./charts -maxdepth 1 -mindepth 1 ! -name 'cluster-log-extension' -exec mv {} "$CHART_DEST_DIR" \;
            
            echo "Archivos del Chart movidos a $CHART_DEST_DIR/."
          
          # 2. Si no lo encontramos allí, verificamos si ya está en la carpeta de destino (en caso de re-run)
          elif [ -f "$CHART_DEST_DIR/Chart.yaml" ]; then
            echo "Chart.yaml ya está en la ubicación final ($CHART_DEST_DIR/). No se requiere movimiento."
          
          # 3. Falla si no lo encuentra en las ubicaciones esperadas
          else
            echo "ERROR: Chart.yaml no se encontró. La ruta esperada es ./charts/Chart.yaml o ya movido a $CHART_DEST_DIR/."
            exit 1 
          fi
          
          echo "--- Estructura de carpetas final (previo a yarn) ---"
          ls -R

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Git Credentials
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.8.0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn
        
      # Sube los archivos preparados al Job 'publish'. Si 'yarn' fue exitoso, 'tmp' existe y está poblada.
      - name: Upload charts artifact
        uses: actions/upload-artifact@v5
        with:
          name: charts
          path: tmp
          if-no-files-found: warn

  # ===================================================================
  # SEGUNDO JOB: PUBLISH (Completo y funcional)
  # ===================================================================
  publish:
    name: Publish charts
    runs-on: ubuntu-24.04
    needs: build
    if: success() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          repository: mgrinbergpractiauy/rancher
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download charts artifact
        uses: actions/download-artifact@v4
        with:
          name: charts
          path: tmp

      - name: Set up Environment Variables
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "TAG_NAME=main" >> $GITHUB_OUTPUT
          else
            echo "TAG_NAME=v1.0.0-manual-test" >> $GITHUB_OUTPUT
          fi
          
      - name: Enable Corepack
        run: corepack enable
        
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn
        
      # --- PASO CRUCIAL: Publicar los artefactos ---
      - name: Publish extensions and charts
        id: publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          publish="yarn publish-pkgs -s ${{ github.repository }} -b gh-pages"

          if [[ -n "${{ steps.env.outputs.TAG_NAME }}" ]]; then
            publish="$publish -t ${{ steps.env.outputs.TAG_NAME }}"
          fi

          if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
            publish="$publish -f"
          fi

          $publish
