name: Build extension artifact

on:
  push:
    branches:
      - 'main'
    paths:
      - 'charts/**'
      - 'extensions/**'
      - 'pkg/**'
      - 'chart/**'
      - 'package.json'
      - 'yarn.lock'
      - '.github/workflows/build-extension-charts.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build extension artifact
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    env:
      EXTENSION_DIR: pkg/cluster-log-extension
      CHART_DIR: charts/cluster-log-extension

    steps:
      # 1. SETUP INICIAL Y DEPENDENCIAS
      - name: Install Missing System Dependencies (checksum fix)
        run: |
          sudo apt-get update
          sudo apt-get install -y coreutils bsdmainutils
          
      - name: Set up Environment Variables
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "TAG_NAME=main" >> $GITHUB_OUTPUT
          else
            echo "TAG_NAME=v1.0.0-manual-test" >> $GITHUB_OUTPUT
          fi
          
      - name: Checkout (normal flow)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          repository: mgrinbergpractiauy/rancher
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 2. REORGANIZACIÓN (Solo el Chart, la UI se queda en pkg/)
      - name: Reorganize Chart Folders
        run: |
          echo "--- Verificando la Extensión (debe permanecer en ${{ env.EXTENSION_DIR }}) ---"
          if [ -d "${{ env.EXTENSION_DIR }}" ]; then
            echo "Extensión de UI confirmada en ${{ env.EXTENSION_DIR }}. No se mueve."
          else
            echo "ERROR: Directorio ${{ env.EXTENSION_DIR }} no encontrado."
            exit 1 
          fi

          echo "--- Reorganizando Chart (Ubicación: ${{ env.CHART_DIR }}) ---"
          mkdir -p "${{ env.CHART_DIR }}"
          
          if [ -f "charts/Chart.yaml" ]; then
            echo "Chart.yaml encontrado en charts/. Moviendo contenidos..."
            find charts -maxdepth 1 -mindepth 1 ! -name 'cluster-log-extension' -exec mv {} "${{ env.CHART_DIR }}" \;
          
          elif [ -f "${{ env.CHART_DIR }}/Chart.yaml" ]; then
            echo "Chart.yaml ya está en la ubicación final. No se requiere movimiento."
          
          else
            echo "ERROR: Chart.yaml no se encontró. Fallo en la reorganización del Chart."
            exit 1 
          fi
          
      # 3. SETUP Y INSTALACIÓN DE DEPENDENCIAS
      - name: Enable Corepack
        run: corepack enable

      - name: Setup Git Credentials
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.8.0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: 'yarn'
          
      - name: Install root dependencies
        run: yarn # Instala las dependencias principales

      # ************ NUEVO PASO CRÍTICO ************
      - name: Create Missing .shell Directory
        run: |
          echo "Creando el directorio de setup faltante que el vue.config de Rancher espera..."
          mkdir -p ${{ env.EXTENSION_DIR }}/.shell
      # **********************************************

      # 4. PASO CRÍTICO: COMPILAR LA UI DENTRO DE SU CARPETA
      - name: Build UI Extension (yarn build)
        working-directory: ${{ env.EXTENSION_DIR }}
        run: |
          echo "Asegurando dependencias de la UI en ${{ env.EXTENSION_DIR }}..."
          yarn install --frozen-lockfile || yarn install 

          echo "Ejecutando yarn build para compilar la UI..."
          yarn build 
          
      # 5. EMPAQUETAR EL ARTEFACTO (Usando Helm directamente)
      - name: Package Chart and Compiled UI Artifact
        run: |
          echo "Empaquetando el Chart usando Helm..."
          mkdir -p tmp
          # El comando 'helm package' crea el .tgz en tmp/.
          helm package ${{ env.CHART_DIR }} -d tmp
          
          # Verificar el artefacto final
          echo "Contenido de la carpeta 'tmp' (debe tener el archivo .tgz):"
          ls -R tmp

      # 6. SUBIR ARTEFACTO
      - name: Upload charts artifact
        uses: actions/upload-artifact@v5
        with:
          name: charts
          path: tmp
          if-no-files-found: error 

  # ===================================================================
  # SEGUNDO JOB: PUBLISH
  # ===================================================================
  publish:
    name: Publish charts
    runs-on: ubuntu-24.04
    needs: build
    if: success() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          repository: mgrinbergpractiauy/rancher
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 1. DESCARGA DEL ARTEFACTO
      - name: Download charts artifact
        uses: actions/download-artifact@v4
        with:
          name: charts
          path: tmp

      # 2. SETUP
      - name: Set up Environment Variables
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "TAG_NAME=main" >> $GITHUB_OUTPUT
          else
            echo "TAG_NAME=v1.0.0-manual-test" >> $GITHUB_OUTPUT
          fi
          
      - name: Enable Corepack
        run: corepack enable
        
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: 'yarn'
          
      # 3. PUBLICAR
      - name: Publish extensions and charts
        id: publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          publish="yarn publish-pkgs -s ${{ github.repository }} -b gh-pages"

          if [[ -n "${{ steps.env.outputs.TAG_NAME }}" ]]; then
            publish="$publish -t ${{ steps.env.outputs.TAG_NAME }}"
          fi

          if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
            publish="$publish -f"
          fi

          $publish
