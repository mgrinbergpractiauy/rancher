name: Build extension artifact

on:
  push:
    branches:
      - 'main'
    paths:
      - 'charts/**'
      - 'extensions/**'
      - 'pkg/**'
      - 'chart/**'
      - 'package.json'
      - 'yarn.lock'
      - '.github/workflows/build-extension-charts.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build extension artifact
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      # 1. SETUP INICIAL Y DEPENDENCIAS
      - name: Install Missing System Dependencies (checksum fix)
        run: |
          sudo apt-get update
          sudo apt-get install -y coreutils bsdmainutils
          
      - name: Set up Environment Variables
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "TAG_NAME=main" >> $GITHUB_OUTPUT
          else
            echo "TAG_NAME=v1.0.0-manual-test" >> $GITHUB_OUTPUT
          fi
          
      - name: Checkout (normal flow)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          repository: mgrinbergpractiauy/rancher
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 2. REORGANIZACIÓN ROBUSTA 
      - name: Reorganize Extension and Chart Folders
        run: |
          echo "--- Reorganizando Extensión (./pkg/cluster-log-extension) ---"
          mkdir -p extensions
          if [ -d "./pkg/cluster-log-extension" ]; then
            mv ./pkg/cluster-log-extension ./extensions/
            echo "Extensión movida correctamente a ./extensions/."
          else
            echo "ERROR: Directorio ./pkg/cluster-log-extension no encontrado. El código fuente debe estar presente."
            exit 1 
          fi

          echo "--- Reorganizando Chart (Ubicación Confirmada: ./charts) ---"
          CHART_DEST_DIR="charts/cluster-log-extension"
          mkdir -p "$CHART_DEST_DIR"
          
          if [ -f "./charts/Chart.yaml" ]; then
            echo "Chart.yaml encontrado en ./charts/. Moviendo contenidos..."
            find ./charts -maxdepth 1 -mindepth 1 ! -name 'cluster-log-extension' -exec mv {} "$CHART_DEST_DIR" \;
          
          elif [ -f "$CHART_DEST_DIR/Chart.yaml" ]; then
            echo "Chart.yaml ya está en la ubicación final ($CHART_DEST_DIR/). No se requiere movimiento."
          
          else
            echo "ERROR: Chart.yaml no se encontró. Fallo en la reorganización del Chart."
            exit 1 
          fi
          
          echo "--- Estructura de carpetas final (previo a yarn) ---"
          ls -R
          
      # 3. SETUP Y INSTALACIÓN DE DEPENDENCIAS
      - name: Enable Corepack
        run: corepack enable

      - name: Setup Git Credentials
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.8.0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn

      # 4. PASO DE CONSTRUCCIÓN FINAL (Usando el script correcto: 'build-pkg')
      - name: Build Extension and Chart Artifact
        run: |
          echo "Ejecutando yarn build-pkg para crear la carpeta 'tmp' y el artefacto..."
          # Usamos el script correcto: build-pkg
          yarn build-pkg
          
          # Verificar si 'tmp' se creó y contiene algo (Para confirmación)
          echo "Contenido de la carpeta 'tmp' después de la construcción:"
          ls -R tmp || echo "La carpeta 'tmp' no se creó o está vacía."

      # 5. SUBIR ARTEFACTO
      - name: Upload charts artifact
        uses: actions/upload-artifact@v5
        with:
          name: charts
          path: tmp
          if-no-files-found: warn

  # ===================================================================
  # SEGUNDO JOB: PUBLISH (No necesita cambios)
  # ===================================================================
  publish:
    name: Publish charts
    runs-on: ubuntu-24.04
    needs: build
    if: success() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          repository: mgrinbergpractiauy/rancher
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 1. DESCARGA DEL ARTEFACTO
      - name: Download charts artifact
        uses: actions/download-artifact@v4
        with:
          name: charts
          path: tmp

      # 2. SETUP
      - name: Set up Environment Variables
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "TAG_NAME=main" >> $GITHUB_OUTPUT
          else
            echo "TAG_NAME=v1.0.0-manual-test" >> $GITHUB_OUTPUT
          fi
          
      - name: Enable Corepack
        run: corepack enable
        
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: 'yarn'
          
      # 3. PUBLICAR
      - name: Publish extensions and charts
        id: publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          publish="yarn publish-pkgs -s ${{ github.repository }} -b gh-pages"

          if [[ -n "${{ steps.env.outputs.TAG_NAME }}" ]]; then
            publish="$publish -t ${{ steps.env.outputs.TAG_NAME }}"
          fi

          if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
            publish="$publish -f"
          fi

          $publish
