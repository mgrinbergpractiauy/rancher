name: Build extension artifact

on:
  push:
    branches:
      - 'main'
    paths:
      - 'charts/**'
      - 'extensions/**'
      - 'pkg/**'
      - 'chart/**'
      - 'package.json'
      - 'yarn.lock'
      - '.github/workflows/build-extension-charts.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build extension artifact
    runs-on: ubuntu-24.04 # Ajustado a una versión más reciente
    permissions:
      contents: write
      pull-requests: write

    steps:
      # --- CORRECCIÓN #1: Dependencia para md5 (incluyendo bsdmainutils) ---
      - name: Install Missing System Dependencies (checksum fix)
        run: |
          sudo apt-get update
          # bsdmainutils provee el comando 'md5' o 'md5sum' si md5 no está
          sudo apt-get install -y coreutils bsdmainutils
          
      - name: Set up Environment Variables
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "TAG_NAME=main" >> $GITHUB_OUTPUT
          else
            echo "TAG_NAME=v1.0.0-manual-test" >> $GITHUB_OUTPUT
          fi
          
      - name: Checkout (normal flow)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          repository: mgrinbergpractiauy/rancher # Usar tu repo
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # --- CORRECCIÓN #2: Reorganizar la Estructura de Carpetas ---
      # Esto mueve los archivos de las rutas de desarrollo (pkg/ y chart) a 
      # las rutas esperadas por el script de publicación (extensions/ y charts/)
      - name: Reorganize Extension and Chart Folders (FIX)
        run: |
          echo "Moviendo extensión de ./pkg/cluster-log-extension a ./extensions/..."
          mkdir -p extensions
          # Mueve el directorio de la extensión
          if [ -d "./pkg/cluster-log-extension" ]; then
            mv ./pkg/cluster-log-extension ./extensions/
          else
            echo "Advertencia: Directorio ./pkg/cluster-log-extension no encontrado."
          fi

          echo "Moviendo chart de ./chart a ./charts/cluster-log-extension..."
          mkdir -p charts/cluster-log-extension
          
          # Mover el contenido de la carpeta 'chart' (singular) a la nueva carpeta del chart (plural/subdirectorio)
          if [ -d "./chart" ]; then
            mv ./chart/* ./charts/cluster-log-extension/
          else
            echo "Advertencia: Directorio ./chart no encontrado, asumiendo chart ya en su lugar."
          fi
          
          # Muestra la nueva estructura para verificación
          ls -R

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Git Credentials
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.8.0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn
        
      # El script de Rancher ahora debería encontrar las carpetas charts/ y extensions/
      - name: Publish extensions and charts
        id: publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          publish="yarn publish-pkgs -s ${{ github.repository }} -b gh-pages"

          if [[ -n "${{ steps.env.outputs.TAG_NAME }}" ]]; then
            publish="$publish -t ${{ steps.env.outputs.TAG_NAME }}"
          fi

          if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
            publish="$publish -f"
          fi

          $publish

      # Sigue igual: subir artefactos de gráficos
      - name: Upload charts artifact
        uses: actions/upload-artifact@v5
        with:
          name: charts
          path: tmp
          if-no-files-found: warn
