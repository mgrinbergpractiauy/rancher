(self["webpackChunkcluster_log_extension"]=self["webpackChunkcluster_log_extension"]||[]).push([[4637],{26190:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>T});var s=t(20641),l=t(90033);const n={key:1,class:"plugin-install-dialog"},i={class:"custom mt-10"},o={class:"custom mt-10"},r={class:"fields"},c={class:"custom mt-10"},m={class:"fields"},d={class:"custom mt-10"},p={class:"fields"},g={class:"dialog-buttons mt-20"};function u(e,a,t,u,h,v){const y=(0,s.g2)("Loading"),f=(0,s.g2)("Banner"),x=(0,s.g2)("LabeledInput"),b=(0,s.g2)("LabeledSelect"),L=(0,s.g2)("AsyncButton"),C=(0,s.gN)("clean-html");return e.$fetchState.loading?((0,s.uX)(),(0,s.Wv)(y,{key:0,mode:"relative"})):((0,s.uX)(),(0,s.CE)("div",n,[(0,s.Lk)("div",null,[(0,s.Lk)("h4",null,(0,l.v_)(e.t("plugins.manageCatalog.imageLoad.load")),1),a[4]||(a[4]=(0,s.eW)()),(0,s.Lk)("p",null,(0,l.v_)(e.t("plugins.manageCatalog.imageLoad.prompt")),1),a[5]||(a[5]=(0,s.eW)()),(0,s.Lk)("div",i,[(0,s.bF)(f,{color:"info",label:e.t("plugins.manageCatalog.imageLoad.banner"),class:"mt-10"},null,8,["label"])]),a[6]||(a[6]=(0,s.eW)()),(0,s.Lk)("div",o,[(0,s.Lk)("div",r,[(0,s.bF)(x,{value:e.deploymentValues.spec.template.spec.containers[0].image,"onUpdate:value":a[0]||(a[0]=a=>e.deploymentValues.spec.template.spec.containers[0].image=a),valueModifiers:{trim:!0},"label-key":"plugins.manageCatalog.imageLoad.fields.image.label","placeholder-key":"plugins.manageCatalog.imageLoad.fields.image.placeholder"},null,8,["value"])])]),a[7]||(a[7]=(0,s.eW)()),(0,s.Lk)("div",c,[(0,s.Lk)("div",m,[(0,s.bF)(b,{value:e.imagePullSecrets,"onUpdate:value":a[1]||(a[1]=a=>e.imagePullSecrets=a),label:e.t("plugins.manageCatalog.imageLoad.fields.imagePullSecrets.label"),tooltip:e.t("plugins.manageCatalog.imageLoad.fields.imagePullSecrets.tooltip"),multiple:!0,taggable:!0,options:e.imagePullNamespacedSecrets,"option-label":"metadata.name",reduce:e=>e.metadata.name},null,8,["value","label","tooltip","options","reduce"]),a[3]||(a[3]=(0,s.eW)()),(0,s.bF)(f,{color:"warning",class:"mt-10"},{default:(0,s.k6)(()=>[(0,s.bo)((0,s.Lk)("span",null,null,512),[[C,e.t("plugins.manageCatalog.imageLoad.fields.secrets.banner",{},!0)]])]),_:1})])])]),a[9]||(a[9]=(0,s.eW)()),(0,s.Lk)("div",d,[(0,s.Lk)("div",p,[(0,s.Lk)("div",g,[(0,s.Lk)("button",{class:"btn role-secondary","data-testid":"image-load-ext-modal-cancel-btn",onClick:a[2]||(a[2]=e=>v.closeDialog())},(0,l.v_)(e.t("generic.cancel")),1),a[8]||(a[8]=(0,s.eW)()),(0,s.bF)(L,{mode:"load","data-testid":"image-load-ext-modal-install-btn",onClick:v.loadImage},null,8,["onClick"])])])])]))}var h=t(66278),v=t(62193),y=t.n(v),f=t(55823),x=t(62428),b=t(15860),L=t(47170),C=t(39262),A=t(72268),S=t(85158),w=t(57090),E=t(14492),D=t(16372);const k={type:f.oU.DEPLOYMENT,metadata:{name:"",namespace:x.th,labels:{}},spec:{replicas:1,selector:{matchLabels:{}},template:{metadata:{namespace:x.th,labels:{}},spec:{containers:[{image:"",imagePullPolicy:"Always",name:"container-0"}],imagePullSecrets:[],restartPolicy:"Always"}}}},R={type:f.YV,metadata:{name:"",namespace:x.th,labels:{[x.v4.CATALOG_IMAGE]:""}},spec:{ports:[{name:"",port:8080,protocol:"TCP",targetPort:8080}],selector:{[x.v4.CATALOG_IMAGE]:""},type:"ClusterIP"}},_={type:f.W8.CLUSTER_REPO,metadata:{name:"",labels:{[x.v4.CATALOG_IMAGE]:""}},spec:{url:null}},P=()=>{const e=structuredClone(k),a=structuredClone(R),t=structuredClone(_);return{deploymentValues:e,serviceValues:a,repoValues:t,canModifyName:!0,canModifyImage:!0,imagePullSecrets:[],imagePullNamespacedSecrets:[],extensionUrl:null,extensionDeployment:null,extensionSvc:null,extensionRepo:null,extensionCrd:null}},V={emits:["close"],components:{AsyncButton:A.A,Banner:E.l,LabeledInput:D.o,Loading:w.A,LabeledSelect:S.A},mixins:[C.A],props:{refresh:{type:Function,default:()=>{},required:!0},closed:{type:Function,default:()=>{},required:!0},resources:{type:Array,default:()=>[]},registerBackgroundClosing:{type:Function,default:()=>{}}},async fetch(){const e={};this.$store.getters["management/canList"](f.oU.DEPLOYMENT)&&(e.deployments=this.$store.dispatch("management/findAll",{type:f.oU.DEPLOYMENT})),this.$store.getters["management/canList"](f.YV)&&(e.services=this.$store.dispatch("management/findAll",{type:f.YV})),await(0,L.kR)(e),this.secondaryResourceData=this.secondaryResourceDataConfig(),this.resourceManagerFetchSecondaryResources(this.secondaryResourceData)},data(){return{...P(),secondaryResourceData:null}},computed:{...(0,h.L8)({allRepos:"catalog/repos"}),namespacedDeployments(){return this.$store.getters["management/all"](f.oU.DEPLOYMENT).filter(e=>e.metadata.namespace===x.th)},namespacedServices(){return this.$store.getters["management/all"](f.YV).filter(e=>e.metadata.namespace===x.th)}},methods:{secondaryResourceDataConfig(){return{namespace:x.th,data:{[f.bB]:{applyTo:[{var:"imagePullNamespacedSecrets",parsingFunc:e=>e.filter(e=>e._type===b.TYPES.DOCKER||e._type===b.TYPES.DOCKER_JSON)}]}}}},closeDialog(e){this.closed(e),Object.assign(this.$data,P()),this.secondaryResourceData=this.secondaryResourceDataConfig(),this.resourceManagerFetchSecondaryResources(this.secondaryResourceData),this.$emit("close")},async loadImage(e){try{if(!y()(this.deploymentValues.spec.template.spec.containers[0].image)){const a=this.deploymentValues.spec.template.spec.containers[0].image,t=this.extractImageName(a);if(!t)throw new Error("Unable to determine image name");await this.loadDeployment(a,t,e),this.extensionDeployment&&await this.loadService(t,e),this.extensionSvc&&await this.loadRepo(t,e),this.extensionRepo&&(e(!0),this.closeDialog(),this.$store.dispatch("growl/success",{title:this.t("plugins.manageCatalog.imageLoad.success.title",{name:t}),message:this.t("plugins.manageCatalog.imageLoad.success.message"),timeout:4e3},{root:!0}),this.refresh())}}catch(a){this.handleGrowlError(a,!0),e(!1)}},async loadDeployment(e,a,t){const s=this.namespacedDeployments.find(a=>a.spec.template.spec.containers[0].image===e);if(s){const a={_statusText:this.t("plugins.manageCatalog.imageLoad.error.exists.deployment.title"),message:this.t("plugins.manageCatalog.imageLoad.error.exists.deployment.message",{image:e})};this.handleGrowlError(a),t(!1)}else{const e=this.parseDeploymentValues(a);this.extensionDeployment=await this.$store.dispatch("management/create",e);try{await this.extensionDeployment.save()}catch(l){this.handleGrowlError(l,!0),t(!1)}}},async loadService(e,a){const t=`${e}-svc`,s=this.namespacedServices.find(e=>e.metadata.name===t);if(s){const e={_statusText:this.t("plugins.manageCatalog.imageLoad.error.exists.service.title"),message:this.t("plugins.manageCatalog.imageLoad.error.exists.service.message",{svc:t})};return this.handleGrowlError(e,!0),void a(!1)}const l=this.parseServiceValues(e,t),n=await this.$store.dispatch("management/create",l);try{await n.save()}catch(i){return this.handleGrowlError(i,!0),void a(!1)}try{if(this.extensionSvc=await this.$store.dispatch("management/find",{type:f.YV,id:`${x.th}/${n.metadata.name}`,namespace:x.th}),!this.extensionSvc)throw new Error("Error fetching extension service");this.extensionUrl=`http://${this.extensionSvc.spec.clusterIP}:${this.extensionSvc.spec.ports[0].port}`}catch(i){this.handleGrowlError(i,!0),a(!1)}},async loadRepo(e,a){const t=`${e}-charts`,s=this.allRepos.find(e=>e.metadata.name===t);if(s){const e={_statusText:this.t("plugins.manageCatalog.imageLoad.error.exists.repo.title"),message:this.t("plugins.manageCatalog.imageLoad.error.exists.repo.message",{repo:t})};return this.handleGrowlError(e),a(!1),void this.clean()}const l=this.parseRepoValues(t);this.extensionRepo=await this.$store.dispatch("management/create",l);try{await this.extensionRepo.save()}catch(n){this.handleGrowlError(n,!0),a(!1)}},parseDeploymentValues(e){let a={};this.deploymentValues.metadata["name"]=e;const t={[x.v4.CATALOG_IMAGE]:e},s=["metadata.labels","spec.selector.matchLabels","spec.template.metadata.labels"];return a=this.assignLabels(this.deploymentValues,t,s),this.imagePullSecrets.length&&(a.spec.template.spec.imagePullSecrets=this.imagePullSecrets.map(e=>({name:e}))),a},parseServiceValues(e,a){const t=this.serviceValues;return t.metadata.name=a,t.metadata.labels[x.v4.CATALOG_IMAGE]=e,t.spec.selector[x.v4.CATALOG_IMAGE]=e,t},parseRepoValues(e){const a=this.repoValues;return a.metadata.name=e,a.metadata.labels[x.v4.CATALOG_IMAGE]=this.deploymentValues.metadata.name,a.spec.url=this.extensionUrl,a},assignLabels(e,a,t){for(let s=0;s<t.length;s++){const l=t[s].split(".");let n=e;for(let e=0;e<l.length-1;e++)n=n[l[e]];n[l[l.length-1]]=a}return e},extractImageVersion(e){const a=/:(\d+\.\d+\.\d+([-\w\d]+)*)$/,t=a.exec(e);return t?t[1]:null},extractImageName(e){const a=/\/([^/:]+)(?::\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?|$)/,t=a.exec(e);return t?t[1]:null},clean(){this.extensionDeployment&&this.extensionDeployment.remove(),this.extensionSvc&&this.extensionSvc.remove(),this.extensionRepo&&this.extensionRepo.remove()},handleGrowlError(e,a=!1){const t=e?.data||e;this.$store.dispatch("growl/error",{title:t._statusText,message:t.message,timeout:5e3},{root:!0}),a&&this.clean()}}};t(63487);var G=t(66262);const $=(0,G.A)(V,[["render",u],["__scopeId","data-v-f920c9b4"]]),T=$},56797:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>c});var s=t(31601),l=t.n(s),n=t(76314),i=t.n(n),o=t(5111),r=i()(l());r.i(o.A),r.push([e.id,".plugin-install-dialog[data-v-f920c9b4]{padding:10px}.plugin-install-dialog h4[data-v-f920c9b4]{font-weight:700}.plugin-install-dialog .dialog-panel[data-v-f920c9b4]{display:flex;flex-direction:column;min-height:100px}.plugin-install-dialog .dialog-panel p[data-v-f920c9b4]{margin-bottom:5px}.plugin-install-dialog .dialog-panel .dialog-info[data-v-f920c9b4]{flex:1}.plugin-install-dialog .dialog-buttons[data-v-f920c9b4]{display:flex;justify-content:flex-end;margin-top:10px}.plugin-install-dialog .dialog-buttons[data-v-f920c9b4]>:not(:last-child){margin-right:10px}",""]);const c=r},63487:(e,a,t)=>{var s=t(56797);s.__esModule&&(s=s.default),"string"===typeof s&&(s=[[e.id,s,""]]),s.locals&&(e.exports=s.locals);var l=t(99548).A;l("1489b1e6",s,!0,{sourceMap:!1,shadowMode:!1})}}]);
//# sourceMappingURL=dialog24.0298b2f8.js.map